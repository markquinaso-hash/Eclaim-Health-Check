name: Email Inline Screenshot (Playwright)

on:
  push:
    branches: [ main ]
    # Optional: only run when these files change
    # paths:
    #   - ".github/workflows/email-inline-screenshot.yml"
    #   - "send_test_email_with_screenshot_playwright.py"
    #   - "requirements.txt"
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}   # allow manual runs from Actions tab
  # Optional: run on a schedule (UTC). Example: every day at 01:30 UTC
  # schedule:
  #   - cron: "30 1 * * *"

jobs:
  send-email:
    runs-on: ubuntu-latest

    # Optional: restrict token permissions (good practice)
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies (Playwright + pytest + dotenv)
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright pytest python-dotenv

      - name: Install Playwright browsers (Chromium) + OS deps
        run: |
          python -m playwright install --with-deps chromium

      # If your test relies on any repo-level .env.example -> .env, do it here
      # - name: Prepare .env
      #   run: cp .env.example .env

      - name: Run pytest (Playwright) and send email
        env:
          # Gmail SMTP (use App Password!)
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL:      ${{ secrets.TO_EMAIL }}

          # Browser behavior
          HEADLESS: "true"
          WINDOW_W: "1366"
          WINDOW_H: "900"

          # App inputs
          CS_HK_URL: "https://www.claimsimple.hk/#/"
          TNC_EMC_URL: "https://www.claimsimple.hk/DoctorSearch#/"
          CLAIM_ID: "A0000000"
          CLAIM_DOB: "01/01/1990"
          EXPECTED_ERROR_TEXT: "The information you provided does not match our records. Please try again."

          # Email behavior + content
          ALWAYS_EMAIL: "true"          # always send an email (in addition to failure)
          EMAIL_ON_FAILURE: "true"      # also email on failure
          USE_SSL_465: "false"          # set true to use SSL (465); false -> STARTTLS (587)
          SUBJECT: "ClaimSimple HK Check â€“ Inline Screenshot"
          BODY: "Hello from CI. Inline screenshot attached below."
          SCREENSHOT_PATH: "screenshot.png"
        run: |
          # Run only the intended test file (ensure the filename is correct and exists)
          pytest -q -s send_test_email_with_screenshot_playwright.py