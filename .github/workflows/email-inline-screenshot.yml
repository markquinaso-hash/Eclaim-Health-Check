name: Email Inline Screenshot (Selenium)

on:
  push:
    branches: [ main ]

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Show workspace files
        run: |
          pwd
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Google Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Show Chrome version
        run: |
          "${{ steps.setup-chrome.outputs.chrome-path }}" --version || true

      - name: Install Python dependencies (Selenium + pytest + dotenv)
        run: |
          python -m pip install --upgrade pip
          python -m pip install selenium pytest python-dotenv webdriver-manager

      - name: Run pytest
        env:
          # Gmail SMTP (use App Password for reliability)
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL:      ${{ secrets.TO_EMAIL }}

          # Selenium/browser
          CHROME_BINARY: ${{ steps.setup-chrome.outputs.chrome-path }}
          HEADLESS: "true"

          # App inputs
          CS_HK_URL: "https://www.claimsimple.hk/#/"
          TNC_EMC_URL: "https://www.claimsimple.hk/DoctorSearch#/"
          CLAIM_ID: "A0000000"
          CLAIM_DOB: "01/01/1990"
          EXPECTED_ERROR_TEXT: "The information you provided does not match our records. Please try again."

          # Email behavior + content
          ALWAYS_EMAIL: "true"
          EMAIL_ON_FAILURE: "true"
          USE_SSL_465: "false"
          SUBJECT: "ClaimSimple HK Check â€“ Inline Screenshot"
          BODY: "Hello from CI. Inline screenshot attached below."
          SCREENSHOT_PATH: "screenshot.png"
        run: |
          pytest -q -s send_test_email_with_screenshot.py